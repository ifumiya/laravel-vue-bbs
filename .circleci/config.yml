version: 2.1

references:
  container_config: &container_config
    docker:
      - image: circleci/php:7.3
        environment: 
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: lvbbs
          DB_USERNAME: laravel
          DB_PASSWORD: lvlaravel
      - image: circleci/mysql:latest-ram
        command: --default-authentication-plugin=mysql_native_password
        environment:
          MYSQL_ROOT_PASSWORD: jfiasdfe
          MYSQL_DATABASE: lvbbs
          MYSQL_USER: laravel
          MYSQL_PASSWORD: lvlaravel
    working_directory: ~/workspace
  
  workspace_root: &workspace_root
    ~/workspace

  attach_workspace: &attach_workspace
    attach_workspace:
      at: *workspace_root


jobs:
  build:
    <<: *container_config
    steps:
      - checkout
      # build environments
      - run:
          name: install middleware
          command: >
            sudo apt-get update &&
            sudo apt-get upgrade -y &&
            sudo apt-get install -y --no-install-recommends libzip-dev unzip libzip4 &&
            sudo docker-php-ext-configure zip --with-libzip &&
            sudo docker-php-ext-install zip &&
            sudo docker-php-ext-install pdo_mysql
      # install dependency
      - restore_cache:
          keys: v1-composer-{{ checksum "app/composer.json" }}
      - run:
          name: composer install
          command:
            composer global require hirak/prestissimo &&
            composer install -n --prefer-dist 
          working_directory: app/
      - save_cache:
          key: composer-v1-{{ checksum "app/composer.lock" }}
          paths:
            - app/vendor
      - run: cp app/.env.example app/.env
      - run: 
          command: php artisan key:generate
          working_directory: app/
      - run: 
          command: php artisan migrate --seed
          working_directory: app/
      - persist_to_workspace:
          root: *workspace_root
          paths:
            - ./

        
  test:
    docker:
      - image: php/7.3
    working_directory: ~/project
    steps:
      - checkout

workflows:
  version: 2
  build_and_test:
    jobs:
      - build
